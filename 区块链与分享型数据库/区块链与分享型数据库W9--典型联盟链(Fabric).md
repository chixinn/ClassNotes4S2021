# 区块链与分享型数据库W9--典型联盟链(Fabric)

## 分类

- 许可链：联盟链和私有链统称；基于许可模式(CA)。
- 非许可链: 一定的信任假设；

## 共识算法

POW c.f. 许可链有身份。

三副本一致性：写操作状态迁移。 Raft/Paxos本质是做什么呢？一个简单的方式保证写操作的一致性--确定唯一的一个输入的操作。(每一个节点确定可以应答)

单个写操作单值，一系列写操作进行排序：排序服务，达成一致。

联盟链：特殊的分布式数据库，(没有币的概念，币的概念c.f.无政府主义)。

## 框架图

![截屏2021-04-25 13.22.23](https://tva1.sinaimg.cn/large/008i3skNly1gpvx7vu1alj30ro0cyjtn.jpg)

智能合约：状态数据。

日志：区块数据，分布式账本，在各方之间达成一致的是区块。

以太坊：先共识再执行

## 特性

![截屏2021-04-25 13.29.40](https://tva1.sinaimg.cn/large/008i3skNly1gpvxf2phsej30vi0agaca.jpg)

公开透明：数据泄露。安全性和可用性之间的trade-off

- Fabric维护两种数据：一种是状态数据，一种是区块数据。

基于一定的信任假设：

![截屏2021-04-25 13.35.53](https://tva1.sinaimg.cn/large/008i3skNly1gpvxlkv2ghj30ry01smxl.jpg)

因为信任假设：BFT不支持，支持CFT。

## Fabric--新的交易模型

![截屏2021-04-25 13.38.51](https://tva1.sinaimg.cn/large/008i3skNly1gpvxolva0aj30vg0gkgr4.jpg)

- 背书：担保；交易不是所有节点执行，只有个别节点(背书节点)模拟执行。

- 客户端发送的交易，制定某几个背书节点执行。执行结果表达成读写集，排序节点进行共识排序后，这个序列给客户端做验证，最终再提交。

- 如何信任背书节点的执行结果（拜占庭错误）？

  判断（多个）两个背书节点返回的结果是不是一样的。

  多个背书节点返回是一模一样，才认为背书正确，发给排序节点。但因为这个code没有被裁减过，如何**避免死循环**or**随机的不确定**的结果。

  高级语言的不确定性在哪里挡在外面？

- 死循环：某种timeout机制挡住这个死循环。

- 随机的不确定的结果：多个背书不一样，也不会进入下一个。

## 步骤总结：运行，共识，验证

1. 背书节点预知性，背书策略，客户端指定哪几个节点

2. 预知性的结果返回给客户端进行检查，检查多个背书节点执行的结果是否相同。

   背书节点执行完会附上签名(签名不可否认不可篡改)

   发给排序节点进行排序(共识)

3. 如果检查所有都无问题，则更改我的账本。

![截屏2021-04-25 13.50.53](https://tva1.sinaimg.cn/large/008i3skNgy1gpvy17c9yrj30pc0dcgpz.jpg)

排序：给出可串行化的序，当序不一样变化时也会abort掉。

容错机制再排序节点共识排序那里可以换掉。

并不是所有节点都执行一摸一样的信息了，真正的执行只在背书节点执行。所以共识理解为只是对执行结果进行共识。

更改账本时，只做验证然后更改即可。

> 注意这里跟以太坊里的先共识再执行不一样，同时注意前提条件是有一定的信任的基础。

## Channel-通道

物理隔离，通道的概念。

不同的通道之间不会有信息的泄漏。

一个节点处于多个通道是允许的。

c.f.宿舍拉小群。



---

c.f. 业务逻辑，无账户。

![截屏2021-04-25 14.02.52](https://tva1.sinaimg.cn/large/008i3skNly1gpvydm6dtaj30uy0dyq7l.jpg)

## 智能合约的保密要求

只能看到读写集了，保密业务逻辑。

![截屏2021-04-25 14.05.35](https://tva1.sinaimg.cn/large/008i3skNly1gpvygff5nsj30tu0bugpt.jpg)

共识：只对写操作共识，不对读操作共识。

以太坊EVM；Fabric容器屏蔽硬件的不一致性。

区块在排序这里生成。

---

历史数据库

记录的是日志

交易：Fabric中交易是对链码的一次调用。

## 账本

![截屏2021-04-25 14.14.55](https://tva1.sinaimg.cn/large/008i3skNly1gpvyq551tjj30vi0gajwf.jpg)

背书节点，预执行一定是记录了**最新的**状态数据。(执行一定是在最新的状态上对合约进行执行)

状态数据：k v数据库

区块数据：放入文件中，不是像以太坊里都放在levelDB里。

---

记住运行共识验证这三个阶段。

只有可信任的背书节点才可以看到完整的代码逻辑。

隐私保护：

1. 数据本身多通道的物理隔离；
2. 智能合约代码业务流程上背书方式的保护；

---

公有链系统高安全为要求；

Fabric：性能瓶颈。



## 新的交易模型

1. 模拟执行
2. 共识排序
3. 验证执行(如果冲突了，不如早一点abort掉)

---

Fabric

- 交易：对智能合约的一次调用。
- 背书
- 链码
- 通道：物理通道/应用通道。
- 排序服务。

---

Fabric:联盟链->多个组织的方式参与其中。组织自己内部又会有很多节点，c.f.上海高校联盟院系等。

区块是排序后生成的，所以每一个组织里有一个节点叫leader节点，它跟排序节点打交道，同步数据。

组织与组织之间交互：

channel成员管理，组织成员管理，区块链网络成员管理,联盟链运行下去是靠超越技术的行政约束力，没有激励机制。

## 权限管理

[数字签名是什么](http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html)

**数字证书**：对公钥的一次认证。【重点理解】

联盟链中的CA。

角色是权限的集合。有admin这个角色，不用把100个权限一个个授予，而是可以一起授予。

MSP:成员服务提供者，是否是这样的一个合法的成员。

Id:权威机构认证的数字证书。

根证书：最原始的自签名的证书，自签名证书派生的中间证书。具有相同的根证书，在同一个信任域里面，这些证书也都有标准的格式。

证书是什么，证书包含什么信息。

---

- Fabric:有一定的信任基础的联盟链，拥有准入机制(CA)，任何进入系统的节点客户，一定被CA授予过数字证书。

